trigger:
    - main

pool:
    name: Default

variables:
    - name: imageName
      value: "flutter-web-realestate"
    - name: containerTempName
      value: "real_estate_app_container_temp"
    - name: deployPath
      value: "/var/www/real_estate_app"

steps:
    - checkout: self
      clean: true
      fetchDepth: 1

    - task: Bash@3
      displayName: "ğŸ” Generar archivo .env desde variables secretas"
      inputs:
        targetType: inline
        script: |
          echo "âš™ï¸ Creando archivo .env con variables de Azure DevOps..."
          echo "API_AUTH=$(API_AUTH)" > .env
          echo "âœ… Archivo .env generado exitosamente"
          
    - task: Docker@2
      displayName: "ğŸ—ï¸ Build de imagen Flutter"
      inputs:
          command: build
          dockerfile: Dockerfile
          repository: $(imageName)
          tags: latest

    - script: |
          echo "ğŸ—‘ï¸ Eliminando carpeta anterior..."
          sudo rm -rf $(deployPath) || true

          echo "ğŸ“¦ Creando contenedor temporal..."
          container_id=$(docker create $(imageName):latest)

          echo "ğŸ“¤ Copiando archivos del contenedor al servidor..."
          docker cp $container_id:/app/build/web $(deployPath)

          echo "ğŸ§¹ Limpiando contenedor temporal..."
          docker rm $container_id

          echo "ğŸ” Ajustando permisos para nginx..."
          sudo chown -R www-data:www-data $(deployPath)
          sudo chmod -R 755 $(deployPath)

          echo "âœ… Deploy completado en $(deployPath)"
      displayName: "ğŸš€ Deploy a Nginx en el host"
